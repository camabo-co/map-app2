<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>åº§æ¨™ãƒãƒƒãƒ—ç™»éŒ²ã‚¢ãƒ—ãƒªï¼ˆå®Œå…¨ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; font-size: 13px; margin: 10px; }
    input, select, button { font-size: 13px; padding: 4px; margin: 3px; }
    #map { height: 800px; width: 800px; border: 1px solid #000; margin-top: 10px; }
  </style>
</head>
<body>

<h2>ğŸ“ åº§æ¨™ãƒãƒƒãƒ—ç™»éŒ²ã‚¢ãƒ—ãƒªï¼ˆGoogleé€£æºï¼‰</h2>

<form id="coordForm">
  <label>ã‚µãƒ¼ãƒãƒ¼å: <input type="text" id="server" required></label>
  <label>X: <input type="number" id="x" required min="0" max="1000"></label>
  <label>Y: <input type="number" id="y" required min="0" max="1000"></label>
  <label>ãƒ¬ãƒ™ãƒ«:
    <select id="level">
      <option>1</option><option>2</option><option>3</option>
      <option>4</option><option>5</option><option>6</option><option>7</option>
    </select>
  </label>
  <label>çŠ¶æ…‹:
    <select id="status">
      <option>æœªå–å¾—</option>
      <option>å–å¾—æ¸ˆã¿</option>
    </select>
  </label>
  <button type="submit">ç™»éŒ²</button>
  <button type="button" onclick="showList()">ğŸ“‹ ä¸€è¦§è¡¨ç¤º</button>
</form>

<div id="map"></div>

<script>
  // âœ… ã”è‡ªèº«ã®Webã‚¢ãƒ—ãƒªURLã«å¤‰æ›´ã—ã¦ãã ã•ã„
  const SPREADSHEET_API_URL = "https://script.google.com/macros/s/AKfycbzUPPfVOSyFHfJTA4Eo1uqxlSxjKtQWq0eI9FIZMYYJq-XQndXRmjHJddGCHtUTaA/exec";

  const levelColors = {
    1: "red", 2: "orange", 3: "yellow",
    4: "green", 5: "blue", 6: "purple", 7: "black"
  };

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 2
  });
  const bounds = [[0, 0], [1000, 1000]];
  L.rectangle(bounds, {color: "#ccc", weight: 1}).addTo(map);
  map.fitBounds(bounds);

  let allData = [];

  function loadMarkers() {
    fetch(SPREADSHEET_API_URL)
      .then(res => res.json())
      .then(data => {
        allData = data;
        data.forEach(item => {
          const x = Number(item["X"]);
          const y = Number(item["Y"]);
          const level = Number(item["ãƒ¬ãƒ™ãƒ«"]);
          const status = item["å–å¾—çŠ¶æ³"];
          const server = item["ã‚µãƒ¼ãƒãƒ¼å"];
          const color = (status === "å–å¾—æ¸ˆã¿") ? "gray" : levelColors[level] || "black";

          L.circleMarker([1000 - y, x], {
            radius: 8,
            color: color,
            fillColor: color,
            fillOpacity: 0.8
          }).addTo(map).bindPopup(
            `ã‚µãƒ¼ãƒãƒ¼: ${server}<br>X: ${x}, Y: ${y}<br>ãƒ¬ãƒ™ãƒ«: ${level}<br>çŠ¶æ…‹: ${status}`
          );
        });
      })
      .catch(err => {
        alert("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
        console.error(err);
      });
  }

  loadMarkers();

  function showList() {
    const æœªå–å¾— = allData.filter(r => r["å–å¾—çŠ¶æ³"] === "æœªå–å¾—");
    const å–å¾—æ¸ˆ = allData.filter(r => r["å–å¾—çŠ¶æ³"] === "å–å¾—æ¸ˆã¿");

    const html = `
      <html><head><meta charset="UTF-8"><title>åº§æ¨™ãƒªã‚¹ãƒˆ</title>
      <style>
        body { font-family: sans-serif; font-size: 13px; margin: 20px; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; font-size: 13px; }
        th, td { border: 1px solid #aaa; padding: 4px; text-align: center; }
      </style>
      </head><body>
      <h3>âœ… ã™ã¹ã¦ã®åº§æ¨™</h3>${renderTable(allData)}
      <h3>ğŸ“¦ å–å¾—å¯èƒ½</h3>${renderTable(æœªå–å¾—)}
      <h3>âœ”ï¸ å–å¾—æ¸ˆã¿</h3>${renderTable(å–å¾—æ¸ˆ)}
      </body></html>
    `;
    const popup = window.open("", "List", "width=600,height=700");
    popup.document.write(html);
  }

  function renderTable(rows) {
    if (rows.length === 0) return "<p>ãªã—</p>";
    let html = `<table><tr><th>ã‚µãƒ¼ãƒãƒ¼å</th><th>X</th><th>Y</th><th>ãƒ¬ãƒ™ãƒ«</th><th>çŠ¶æ…‹</th></tr>`;
    rows.forEach(r => {
      html += `<tr><td>${r["ã‚µãƒ¼ãƒãƒ¼å"]}</td><td>${r["X"]}</td><td>${r["Y"]}</td><td>${r["ãƒ¬ãƒ™ãƒ«"]}</td><td>${r["å–å¾—çŠ¶æ³"]}</td></tr>`;
    });
    return html + `</table>`;
  }

  document.getElementById("coordForm").addEventListener("submit", e => {
    e.preventDefault();

    const payload = {
      "ã‚µãƒ¼ãƒãƒ¼å": document.getElementById("server").value,
      "X": document.getElementById("x").value,
      "Y": document.getElementById("y").value,
      "ãƒ¬ãƒ™ãƒ«": document.getElementById("level").value,
      "å–å¾—çŠ¶æ³": document.getElementById("status").value
    };

    fetch(SPREADSHEET_API_URL, {
      method: "POST",
      body: JSON.stringify(payload),
      headers: { "Content-Type": "application/json" }
    }).then(res => {
      alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
      location.reload(); // å†èª­ã¿è¾¼ã¿ã—ã¦åœ°å›³ã«è¡¨ç¤º
    }).catch(err => {
      alert("ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
      console.error(err);
    });
  });
</script>

</body>
</html>
