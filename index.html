<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“åº§æ¨™ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªï¼ˆmap2ï¼‰</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; font-size: 14px; }
    label, input, select, button { margin: 2px; }
    #map { height: 400px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>ğŸ“åº§æ¨™ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªï¼ˆmap2ï¼‰</h2>
  <div>
    <label>ã‚µãƒ¼ãƒãƒ¼å: <input id="server" /></label><br />
    <label>X: <input id="x" /></label><br />
    <label>Y: <input id="y" /></label><br />
    <label>ãƒ¬ãƒ™ãƒ«: 
      <select id="level">
        <option>1</option><option>2</option><option>3</option>
      </select>
    </label><br />
    <label>çŠ¶æ…‹:
      <select id="status">
        <option>æœªå–å¾—</option>
        <option>å–å¾—æ¸ˆã¿</option>
      </select>
    </label>
    <button onclick="registerPoint()">ç™»éŒ²</button>
  </div>

  <div>
    <label>ãƒ¬ãƒ™ãƒ«: 
      <select id="filterLevel"><option value="">ã™ã¹ã¦</option><option>1</option><option>2</option><option>3</option></select>
    </label>
    <label>çŠ¶æ…‹: 
      <select id="filterStatus"><option value="">ã™ã¹ã¦</option><option>æœªå–å¾—</option><option>å–å¾—æ¸ˆã¿</option></select>
    </label>
    <button onclick="loadData()">ğŸ” çµã‚Šè¾¼ã¿è¡¨ç¤º</button>
  </div>

  <p><button onclick="window.open('list.html', '_blank')">ğŸ“‹ ä¸€è¦§ï¼ˆåˆ¥ç”»é¢ï¼‰ã‚’é–‹ã</button></p>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw5JEsMFdIHWt3zbkeFFesRfgj1D9Xpd5_Fdg5YrYSmFgvlkCL-7G9lu0-9MONHh5s/exec";
    const map = L.map('map').setView([500, 500], 2);
    const markerLayer = L.layerGroup().addTo(map);
    const levelColors = { 1: 'green', 2: 'orange', 3: 'red' };
    let latestData = [];

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    function loadData() {
      markerLayer.clearLayers();
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          latestData = data;
          const fLevel = document.getElementById('filterLevel').value;
          const fStatus = document.getElementById('filterStatus').value;

          data.forEach((item, idx) => {
            if (item["å–å¾—çŠ¶æ³"] === "å–å¾—æ¸ˆã¿") return;
            if ((fLevel && item["ãƒ¬ãƒ™ãƒ«"] != fLevel) || (fStatus && item["å–å¾—çŠ¶æ³"] != fStatus)) return;

            const x = Number(item["X"]);
            const y = Number(item["Y"]);
            const level = Number(item["ãƒ¬ãƒ™ãƒ«"]);
            const color = levelColors[level] || "black";

            const marker = L.circleMarker([1000 - y, x], {
              radius: 6,
              color: color,
              fillColor: color,
              fillOpacity: 0.9
            }).addTo(markerLayer).bindPopup(
              `<b>${item["ã‚µãƒ¼ãƒãƒ¼å"]}</b><br>X:${x} Y:${y}<br>Lv:${level}<br>${item["å–å¾—çŠ¶æ³"]}<br>` +
              `<button onclick='markObtained(${idx})'>âœ… å–å¾—æ¸ˆã¿ã«</button>`
            );
          });
        });
    }

    function registerPoint() {
      const data = {
        ã‚µãƒ¼ãƒãƒ¼å: document.getElementById('server').value,
        X: document.getElementById('x').value,
        Y: document.getElementById('y').value,
        ãƒ¬ãƒ™ãƒ«: document.getElementById('level').value,
        å–å¾—çŠ¶æ³: document.getElementById('status').value
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(res => res.text()).then(() => {
        alert("ç™»éŒ²ã—ã¾ã—ãŸï¼");
        loadData();
      });
    }

    function markObtained(idx) {
      const data = latestData[idx];
      data["å–å¾—çŠ¶æ³"] = "å–å¾—æ¸ˆã¿";
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(() => loadData());
    }

    loadData();
  </script>
</body>
</html>
