<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>åº§æ¨™ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªï¼ˆmap2ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #map { height: 500px; margin-top: 10px; }
    input, select, button { margin: 3px; padding: 4px; }
    .link-btns a { margin-right: 10px; text-decoration: none; }
  </style>
</head>
<body>
  <h2>ğŸ“ åº§æ¨™ãƒãƒƒãƒ—ã‚¢ãƒ—ãƒªï¼ˆmap2ï¼‰</h2>

  <div>
    ã‚µãƒ¼ãƒãƒ¼å: <input type="text" id="serverName" size="6" />
    X: <input type="number" id="xCoord" size="4" />
    Y: <input type="number" id="yCoord" size="4" />
    ãƒ¬ãƒ™ãƒ«:
    <select id="level">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    </select>
    çŠ¶æ…‹:
    <select id="status">
      <option value="æœªå–å¾—">æœªå–å¾—</option>
      <option value="å–å¾—æ¸ˆã¿">å–å¾—æ¸ˆã¿</option>
    </select>
    <button onclick="registerCoord()">ç™»éŒ²</button>
  </div>

  <div>
    ãƒ¬ãƒ™ãƒ«:
    <select id="filterLevel">
      <option value="">ã™ã¹ã¦</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    </select>
    çŠ¶æ…‹:
    <select id="filterStatus">
      <option value="">ã™ã¹ã¦</option>
      <option value="æœªå–å¾—">æœªå–å¾—</option>
      <option value="å–å¾—æ¸ˆã¿">å–å¾—æ¸ˆã¿</option>
    </select>
    <button onclick="loadData()">ğŸ” çµã‚Šè¾¼ã¿è¡¨ç¤º</button>
  </div>

  <div class="link-btns">
    <a href="list_uncollected.html" target="_blank">ğŸ“‹ æœªå–å¾—ä¸€è¦§</a>
    <a href="list_collected.html" target="_blank">ğŸ“‹ å–å¾—æ¸ˆã¿ä¸€è¦§</a>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw5JEsMFdIHWt3zbkeFFesRfgj1D9Xpd5_Fdg5YrYSmFgvlkCL-7G9lu0-9MONHh5s/exec";
    const levelColors = { 1: "blue", 2: "green", 3: "red" };
    let markerLayer = L.layerGroup();
    let latestData = [];

    const map = L.map('map').setView([500, 500], 2);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markerLayer.addTo(map);

    function loadData() {
      markerLayer.clearLayers();
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          latestData = data;

          const fLevel = document.getElementById('filterLevel').value;
          const fStatus = document.getElementById('filterStatus').value;

          data.forEach((item, idx) => {
            if (item["å–å¾—çŠ¶æ³"] === "å–å¾—æ¸ˆã¿") return; // å–å¾—æ¸ˆã¿ã¯åœ°å›³éè¡¨ç¤º
            if ((fLevel && item["ãƒ¬ãƒ™ãƒ«"] != fLevel) || (fStatus && item["å–å¾—çŠ¶æ³"] != fStatus)) return;

            const x = Number(item["X"]);
            const y = Number(item["Y"]);
            const level = Number(item["ãƒ¬ãƒ™ãƒ«"]);
            const color = levelColors[level] || "black";

            const marker = L.circleMarker([1000 - y, x], {
              radius: 6, color: color, fillColor: color, fillOpacity: 0.9
            }).addTo(markerLayer).bindPopup(
              `<b>${item["ã‚µãƒ¼ãƒãƒ¼å"]}</b><br>X:${x} Y:${y}<br>Lv:${level}<br>` +
              `<button onclick='markObtained(${idx})'>âœ… å–å¾—æ¸ˆã¿ã«</button>`
            );
          });
        });
    }

    function registerCoord() {
      const data = {
        "ã‚µãƒ¼ãƒãƒ¼å": document.getElementById("serverName").value,
        "X": document.getElementById("xCoord").value,
        "Y": document.getElementById("yCoord").value,
        "ãƒ¬ãƒ™ãƒ«": document.getElementById("level").value,
        "å–å¾—çŠ¶æ³": document.getElementById("status").value
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(() => {
        alert("ç™»éŒ²ã•ã‚Œã¾ã—ãŸï¼");
        loadData();
      });
    }

    function markObtained(idx) {
      const item = latestData[idx];
      const postData = {
        "ã‚µãƒ¼ãƒãƒ¼å": item["ã‚µãƒ¼ãƒãƒ¼å"],
        "X": item["X"],
        "Y": item["Y"],
        "ãƒ¬ãƒ™ãƒ«": item["ãƒ¬ãƒ™ãƒ«"],
        "å–å¾—çŠ¶æ³": "å–å¾—æ¸ˆã¿"
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(postData)
      }).then(() => {
        alert("å–å¾—æ¸ˆã¿ã«å¤‰æ›´ã—ã¾ã—ãŸï¼");
        loadData();
      });
    }

    loadData();
  </script>
</body>
</html>
