<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>座標マップアプリ（map2）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; padding: 10px; }
    #map { height: 500px; margin-top: 10px; }
    input, select, button { margin: 3px; padding: 4px; }
    .link-btns a { margin-right: 10px; text-decoration: none; }
  </style>
</head>
<body>
  <h2>📍 座標マップアプリ（map2）</h2>

  <div>
    サーバー名: <input type="text" id="serverName" size="6" />
    X: <input type="number" id="xCoord" size="4" />
    Y: <input type="number" id="yCoord" size="4" />
    レベル:
    <select id="level">
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    </select>
    状態:
    <select id="status">
      <option value="未取得">未取得</option>
      <option value="取得済み">取得済み</option>
    </select>
    <button onclick="registerCoord()">登録</button>
  </div>

  <div>
    レベル:
    <select id="filterLevel">
      <option value="">すべて</option>
      <option value="1">1</option><option value="2">2</option><option value="3">3</option>
    </select>
    状態:
    <select id="filterStatus">
      <option value="">すべて</option>
      <option value="未取得">未取得</option>
      <option value="取得済み">取得済み</option>
    </select>
    <button onclick="loadData()">🔍 絞り込み表示</button>
  </div>

  <div class="link-btns">
    <a href="list_uncollected.html" target="_blank">📋 未取得一覧</a>
    <a href="list_collected.html" target="_blank">📋 取得済み一覧</a>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw5JEsMFdIHWt3zbkeFFesRfgj1D9Xpd5_Fdg5YrYSmFgvlkCL-7G9lu0-9MONHh5s/exec";
    const levelColors = { 1: "blue", 2: "green", 3: "red" };
    let markerLayer = L.layerGroup();
    let latestData = [];

    const map = L.map('map').setView([500, 500], 2);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);
    markerLayer.addTo(map);

    function loadData() {
      markerLayer.clearLayers();
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          latestData = data;

          const fLevel = document.getElementById('filterLevel').value;
          const fStatus = document.getElementById('filterStatus').value;

          data.forEach((item, idx) => {
            if (item["取得状況"] === "取得済み") return; // 取得済みは地図非表示
            if ((fLevel && item["レベル"] != fLevel) || (fStatus && item["取得状況"] != fStatus)) return;

            const x = Number(item["X"]);
            const y = Number(item["Y"]);
            const level = Number(item["レベル"]);
            const color = levelColors[level] || "black";

            const marker = L.circleMarker([1000 - y, x], {
              radius: 6, color: color, fillColor: color, fillOpacity: 0.9
            }).addTo(markerLayer).bindPopup(
              `<b>${item["サーバー名"]}</b><br>X:${x} Y:${y}<br>Lv:${level}<br>` +
              `<button onclick='markObtained(${idx})'>✅ 取得済みに</button>`
            );
          });
        });
    }

    function registerCoord() {
      const data = {
        "サーバー名": document.getElementById("serverName").value,
        "X": document.getElementById("xCoord").value,
        "Y": document.getElementById("yCoord").value,
        "レベル": document.getElementById("level").value,
        "取得状況": document.getElementById("status").value
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(() => {
        alert("登録されました！");
        loadData();
      });
    }

    function markObtained(idx) {
      const item = latestData[idx];
      const postData = {
        "サーバー名": item["サーバー名"],
        "X": item["X"],
        "Y": item["Y"],
        "レベル": item["レベル"],
        "取得状況": "取得済み"
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(postData)
      }).then(() => {
        alert("取得済みに変更しました！");
        loadData();
      });
    }

    loadData();
  </script>
</body>
</html>
