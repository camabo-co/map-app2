<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>📍座標マップアプリ（map2）</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: sans-serif; font-size: 14px; }
    label, input, select, button { margin: 2px; }
    #map { height: 400px; margin-top: 10px; }
  </style>
</head>
<body>
  <h2>📍座標マップアプリ（map2）</h2>
  <div>
    <label>サーバー名: <input id="server" /></label><br />
    <label>X: <input id="x" /></label><br />
    <label>Y: <input id="y" /></label><br />
    <label>レベル: 
      <select id="level">
        <option>1</option><option>2</option><option>3</option>
      </select>
    </label><br />
    <label>状態:
      <select id="status">
        <option>未取得</option>
        <option>取得済み</option>
      </select>
    </label>
    <button onclick="registerPoint()">登録</button>
  </div>

  <div>
    <label>レベル: 
      <select id="filterLevel"><option value="">すべて</option><option>1</option><option>2</option><option>3</option></select>
    </label>
    <label>状態: 
      <select id="filterStatus"><option value="">すべて</option><option>未取得</option><option>取得済み</option></select>
    </label>
    <button onclick="loadData()">🔍 絞り込み表示</button>
  </div>

  <p><button onclick="window.open('list.html', '_blank')">📋 一覧（別画面）を開く</button></p>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw5JEsMFdIHWt3zbkeFFesRfgj1D9Xpd5_Fdg5YrYSmFgvlkCL-7G9lu0-9MONHh5s/exec";
    const map = L.map('map').setView([500, 500], 2);
    const markerLayer = L.layerGroup().addTo(map);
    const levelColors = { 1: 'green', 2: 'orange', 3: 'red' };
    let latestData = [];

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18
    }).addTo(map);

    function loadData() {
      markerLayer.clearLayers();
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          latestData = data;
          const fLevel = document.getElementById('filterLevel').value;
          const fStatus = document.getElementById('filterStatus').value;

          data.forEach((item, idx) => {
            if (item["取得状況"] === "取得済み") return;
            if ((fLevel && item["レベル"] != fLevel) || (fStatus && item["取得状況"] != fStatus)) return;

            const x = Number(item["X"]);
            const y = Number(item["Y"]);
            const level = Number(item["レベル"]);
            const color = levelColors[level] || "black";

            const marker = L.circleMarker([1000 - y, x], {
              radius: 6,
              color: color,
              fillColor: color,
              fillOpacity: 0.9
            }).addTo(markerLayer).bindPopup(
              `<b>${item["サーバー名"]}</b><br>X:${x} Y:${y}<br>Lv:${level}<br>${item["取得状況"]}<br>` +
              `<button onclick='markObtained(${idx})'>✅ 取得済みに</button>`
            );
          });
        });
    }

    function registerPoint() {
      const data = {
        サーバー名: document.getElementById('server').value,
        X: document.getElementById('x').value,
        Y: document.getElementById('y').value,
        レベル: document.getElementById('level').value,
        取得状況: document.getElementById('status').value
      };

      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(res => res.text()).then(() => {
        alert("登録しました！");
        loadData();
      });
    }

    function markObtained(idx) {
      const data = latestData[idx];
      data["取得状況"] = "取得済み";
      fetch(API_URL, {
        method: "POST",
        body: JSON.stringify(data)
      }).then(() => loadData());
    }

    loadData();
  </script>
</body>
</html>
