<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>座標マップ登録アプリ（Google連携）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body { font-family: sans-serif; font-size: 12px; margin: 10px; }
    #map { height: 800px; width: 800px; border: 1px solid #000; margin-top: 10px; }
    .popup { font-size: 11px; }
  </style>
</head>
<body>

<h2>📍 座標マップ登録アプリ（Googleスプレッドシート連携）</h2>
<p>スプレッドシートから座標データを読み込み、地図に表示します。</p>

<div id="map"></div>

<script>
  const SPREADSHEET_API_URL = "https://script.google.com/macros/s/AKfycbwWlWagyvdi8dyg_7OnnH6dgjbDRK-xyWeq9Eyt02O-0KaEAwuK9fPS9WtucC7bLiE/exec";

  const levelColors = {
    1: "red", 2: "orange", 3: "yellow",
    4: "green", 5: "blue", 6: "purple", 7: "black"
  };

  const map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -1,
    maxZoom: 2
  });
  const bounds = [[0, 0], [1000, 1000]];
  L.rectangle(bounds, {color: "#ccc", weight: 1}).addTo(map);
  map.fitBounds(bounds);

  fetch(SPREADSHEET_API_URL)
    .then(res => res.json())
    .then(data => {
      data.forEach(item => {
        const x = Number(item["X"]);
        const y = Number(item["Y"]);
        const level = Number(item["レベル"]);
        const status = item["取得状況"];
        const server = item["サーバー名"] || item["サーバー"];

        const color = (status === "取得済み" || status === "取得済") ? "gray" : levelColors[level] || "black";

        const marker = L.circleMarker([1000 - y, x], {
          radius: 7,
          color: color,
          fillColor: color,
          fillOpacity: 0.8
        }).addTo(map).bindPopup(
          `<div class="popup">🗺️ サーバー: ${server}<br>X: ${x}, Y: ${y}<br>レベル: ${level}<br>状態: ${status}</div>`
        );
      });
    })
    .catch(err => {
      alert("スプレッドシートからデータを取得できませんでした。URLや公開設定を確認してください。");
      console.error(err);
    });
</script>

</body>
</html>
